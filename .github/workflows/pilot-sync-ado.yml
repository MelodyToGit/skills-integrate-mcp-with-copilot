name: üöÄ Pilot - Sync ADO Query to GitHub (‰º†ÁªüÊñπÊ°à)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */4 * * *'  # Â∑≤Á¶ÅÁî®Ëá™Âä®ËøêË°å

# Ê∑ªÂä†ÂøÖË¶ÅÁöÑÊùÉÈôê
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  sync-pilot-query:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync ADO Query Items to Pilot Repo
        uses: actions/github-script@v6
        env:
          ADO_TOKEN: ${{ secrets.ADO_PAT }}
          ADO_ORG: ${{ secrets.ADO_ORG }}
        with:
          script: |
            console.log('üöÄ Starting Pilot Sync from ADO Query...');
            
            async function syncQueryWorkItems() {
              const adoProject = 'EMR-DigMod';
              const githubRepo = 'MelodyToGit/skills-integrate-mcp-with-copilot';
              const [owner, repo] = githubRepo.split('/');
              
              console.log('üìã Using optimized WIQL query...');
              await tryOptimizedQuery(adoProject, owner, repo);
            }

            async function tryOptimizedQuery(adoProject, owner, repo) {
              // ‰ºòÂåñÊü•ËØ¢ÔºöÈôêÂà∂ËøîÂõûÊï∞ÈáèÂíåÊó∂Èó¥ËåÉÂõ¥
              const wiqlQueries = [
                {
                  name: "Recent Active Bugs",
                  query: "SELECT [System.Id], [System.Title], [System.WorkItemType], [System.State] FROM WorkItems WHERE [System.WorkItemType] = 'Bug' AND [System.State] = 'Active' AND [System.ChangedDate] >= @today - 7 ORDER BY [System.ChangedDate] DESC"
                }
              ];

              for (const queryConfig of wiqlQueries) {
                console.log('üîÑ Trying query: ' + queryConfig.name);
                
                const success = await executeQuery(queryConfig.query, adoProject, owner, repo);
                if (success) {
                  break; // Â¶ÇÊûúÊúâ‰∏Ä‰∏™Êü•ËØ¢ÊàêÂäüÔºåÂ∞±ÂÅúÊ≠¢Â∞ùËØï
                }
              }
            }

            async function executeQuery(wiql, adoProject, owner, repo) {
              try {
                const queryResponse = await fetch(
                  'https://dev.azure.com/' + process.env.ADO_ORG + '/' + adoProject + '/_apis/wit/wiql?api-version=6.0',
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': 'Basic ' + Buffer.from(':' + process.env.ADO_TOKEN).toString('base64')
                    },
                    body: JSON.stringify({ query: wiql })
                  }
                );

                if (!queryResponse.ok) {
                  console.log('‚ùå Query failed: ' + queryResponse.status);
                  const errorText = await queryResponse.text();
                  console.log('Error: ' + errorText);
                  return false;
                }

                const queryResult = await queryResponse.json();
                await processQueryResult(queryResult, adoProject, owner, repo);
                return true;
                
              } catch (error) {
                console.log('‚ùå Query execution error: ' + error.message);
                return false;
              }
            }

            async function processQueryResult(queryResult, adoProject, owner, repo) {
              console.log('‚úÖ Query returned ' + (queryResult.workItems?.length || 0) + ' items');
              
              if (queryResult.workItems && queryResult.workItems.length > 0) {
                // Âè™ÂêåÊ≠•Ââç2‰∏™‰Ωú‰∏∫ÂàùÂßãÊµãËØï
                const itemsToSync = queryResult.workItems.slice(0, 2);
                console.log('üîÑ Syncing first ' + itemsToSync.length + ' items...');
                
                for (const workItemRef of itemsToSync) {
                  await syncWorkItem(workItemRef.id, adoProject, owner, repo);
                }
              } else {
                console.log('‚ÑπÔ∏è No work items found in the query');
              }
            }

            async function syncWorkItem(workItemId, adoProject, owner, repo) {
              try {
                console.log('üì• Fetching ADO work item: ' + workItemId);
                
                const workItemResponse = await fetch(
                  'https://dev.azure.com/' + process.env.ADO_ORG + '/_apis/wit/workitems/' + workItemId + '?api-version=6.0',
                  {
                    headers: {
                      'Authorization': 'Basic ' + Buffer.from(':' + process.env.ADO_TOKEN).toString('base64')
                    }
                  }
                );

                if (!workItemResponse.ok) {
                  console.log('‚ùå Failed to fetch work item ' + workItemId + ': ' + workItemResponse.status);
                  return;
                }

                const workItem = await workItemResponse.json();
                await createGitHubIssue(workItem, adoProject, owner, repo);
              } catch (error) {
                console.log('‚ùå Error syncing work item ' + workItemId + ': ' + error.message);
              }
            }

            async function createGitHubIssue(workItem, adoProject, owner, repo) {
              const issueTitle = '[ADO-' + workItem.id + '] ' + workItem.fields['System.Title'];
              const labels = ['pilot-sync', 'ado-bug', 'ado-' + workItem.id];
              const issueBody = generateIssueBody(workItem, adoProject);

              try {
                console.log('üìù Creating GitHub issue for ADO-' + workItem.id);
                
                // ÂàõÂª∫Êñ∞IssueÂπ∂ÂàÜÈÖçÁªôCopilot
                const newIssue = await github.rest.issues.create({
                  owner,
                  repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: labels,
                  assignees: ['copilot']
                });
                
                console.log('‚úÖ Successfully created issue #' + newIssue.data.number + ' for ADO-' + workItem.id);
                console.log('ü§ñ Issue assigned to Copilot');
                
                // Ê∑ªÂä†ÂàùÂßãËØÑËÆ∫
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: newIssue.data.number,
                  body: '## ü§ñ Copilot Analysis Ready\n\nThis issue has been synced from Azure DevOps and is ready for Copilot analysis.\n\n**ADO Link:** https://dev.azure.com/' + process.env.ADO_ORG + '/' + adoProject + '/_workitems/edit/' + workItem.id
                });
                
                return newIssue.data.number;
                
              } catch (error) {
                console.log('‚ùå Error creating GitHub issue: ' + error.message);
                if (error.status === 403) {
                  console.log('üîí Permission denied. Please check GitHub token permissions.');
                } else if (error.message.includes('copilot')) {
                  console.log('‚ö†Ô∏è Note: Copilot assignment may not be available for this repository');
                }
                return null;
              }
            }

            function generateIssueBody(workItem, adoProject) {
              const description = workItem.fields['System.Description'] || 'No description provided.';
              const state = workItem.fields['System.State'] || 'New';
              const createdDate = new Date(workItem.fields['System.CreatedDate']).toLocaleDateString();
              
              return [
                '### üêõ Azure DevOps Bug - Pilot Sync',
                '',
                '**ADO ID:** ' + workItem.id,
                '**Type:** ' + workItem.fields['System.WorkItemType'],
                '**State:** ' + state,
                '**Project:** ' + adoProject,
                '**Created:** ' + createdDate,
                '',
                '### Description',
                description,
                '',
                '### üîó Links',
                '- [View in Azure DevOps](https://dev.azure.com/' + process.env.ADO_ORG + '/' + adoProject + '/_workitems/edit/' + workItem.id + ')',
                '',
                '---',
                '*üöÄ Pilot synchronization from ADO to GitHub for Copilot analysis*'
              ].join('\n');
            }

            // ÊâßË°åÂêåÊ≠•
            await syncQueryWorkItems();
